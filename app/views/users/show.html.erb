<!-- Updates positions each time the page is refreshed -->
<% @positions.each do | position | %>
  <% position.gain_loss_closed %>
<% end %>

<div class="container-fluid" style="width:90%">
  <div class="d-flex justify-content-between">
    <div class="profile-overview d-flex text-center">
      <div class="personnal-info">
        <h2 class="mb-3 text-center"><%= @user.nickname %></h2>
        <p><%= @user.description %></p>
      </div>
    </div>
    <div class="profile-overview d-flex">
      <div class="sector-info center">
        <h2 class="text-center mb-3">Sectors</h2><div class="container sector-color"><%=  @user.category  %></div>
      </div>
      <div class="finance-info-1">
        <div class="container wallet-overview">
          <% positions = Position.where(user_id: @user) %>
          <% count = 0 %>
          <% positions.each do | position | %>
            <% if position.remaining_size == 0%>
             <% count += 1 %>
            <% end %>
          <% end %>
          <p>Positions: <%= @positions.count - count %></p>
          <p>Wallet: <%= number_to_currency(@user.cash + @user.equity) %></p>
          <p>Equity: <%= number_to_currency(@user.equity) %></p>
          <p>Cash: <%= number_to_currency(@user.cash) %></p>
          <div class="d-flex"><p>P/L: <%= number_to_currency((@user.cash + @user.equity)-(100000)) %></p>
          <% if @user == current_user%>
          <div><p class="ml-3 avatar-refresh"><%= link_to image_tag("refresh.svg"), refresh_path %></p></div></div>
        </div>
        <div class="d-flex pt-2">
            <div class="mr-2 pl-3"><p><%= link_to "No wallet", no_wallet_path, data: { confirm: 'Are you sure you want to delete your wallet?' } %></p></div>
            <div><p class="ml-3"><%= link_to "Reset", reset_path, data: { confirm: 'Are you sure you want to reset your wallet?' } %></p></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>




 <table class="table table-hover table-dark">
  <thead>
    <tr>
      <th class= "table-text-color" scope="col">Symbol</th>
      <th class= "table-text-color" scope="col">Date</th>
      <th class= "table-text-color" scope="col">Time</th>
      <th class= "table-text-color" scope="col">Buy/Sell</th>
      <th class= "table-text-color" scope="col">Size</th>
      <th class= "table-text-color" scope="col">Entry</th>
      <th class= "table-text-color" scope="col">Total</th>
      <th class= "table-text-color" scope="col">IceL</th>
      <th class= "table-text-color" scope="col">Target</th>
      <th class= "table-text-color" scope="col">S/L</th>
      <th class= "table-text-color" scope="col">Price</th>
      <th class= "table-text-color" scope="col">P/L%</th>
      <th class= "table-text-color" scope="col">1R</th>
      <th class= "table-text-color" scope="col">2R</th>
      <th class= "table-text-color" scope="col">3R</th>
      <th class= "table-text-color" scope="col">Shares</th>
      <th class= "table-text-color" scope="col">P/L</th>
      <th class= "table-text-color" scope="col">Wallet%</th>
    </tr>
  </thead>
    <!-- refresh positions to appear in table -->
    <% @positions.each do | position | %>
      <% position.gain_loss_closed %>
    <% end %>

  <tbody>
    <% @positions.each do | position | %>
    <tr class="border">
      <td class= "table-text-color" scope="row"><%= position.stock.symbol%></td>
      <td class= "table-text-color" scope="row"><%=position.created_at.to_date.strftime("%m/%d") %></td>
      <td class= "table-text-color" scope="row"><%=position.created_at.to_time.getlocal('-04:00').strftime("%k:%M") %></td>
      <td class= "table-text-color" scope="row"><%=position.buy_sell%></td>
      <td class= "table-text-color" scope="row"><%=position.size%></td>
      <td class= "table-text-color" scope="row"><%= position.entry.round(2)%></td>
      <td class= "table-text-color" scope="row"><%= number_to_currency(position.total_amount) %></td>
      <td class= "table-text-color" scope="row"><%= position.baseline.round(2) %></td>
      <td class= "table-text-color" scope="row"><%= position.target.round(2) %></td>
      <td class= "table-text-color" scope="row">
        <% if position.stop_loss_hit %>
        <div class="stock_ticker_SL_hit"><%= position.stop_loss.round(2) %></div>
        <% else %>
        <%= position.stop_loss.round(2) %>
        <% end %>
        </td>
      <td class= "table-text-color" scope="row"><%= position.current_price.round(2) %></td>
      <td class= "table-text-color" scope="row"><%= ((position.gain_loss_percentage)*100).round(2) %>%</td>
      <td class= "table-text-color" scope="row">
        <% if position.r1_hit%>
         <div class="stock_ticker_R_hit"><%= position.r1.round(2) %></div>
         <% else %>
         <%= position.r1.round(2) %>
        <% end %>
      </td>
      <td class= "table-text-color" scope="row">
        <% if position.r2_hit%>
         <div class="stock_ticker_R_hit"><%= position.r2.round(2) %></div>
         <% else %>
         <%= position.r2.round(2) %>
        <% end %>
      </td>
      <td class= "table-text-color" scope="row">
        <% if position.r3_hit%>
         <div class="stock_ticker_R_hit"><%= position.r3.round(2) %></div>
         <% else %>
         <%= position.r3.round(2) %>
        <% end %>
      </td>
      <td class= "table-text-color" scope="row"><%= position.remaining_size%></td>
      <td class= "table-text-color" scope="row">
        <% if position.p_l_closed != "N/A" %>
          <%= number_to_currency(position.p_l_closed) %>
          <% else %>
          <%= position.p_l_closed %>
        <% end %> </td>
      <td class= "table-text-color" scope="row"><%=position.portfolio_return%></td>
    </tr>
    <% end %>
  </tbody>
 </table>

<div class="goldbar"></div>
<!-- TradingView Widget BEGIN -->
<div class="tradingview-widget-container" >
  <div id="tradingview_ffdae" class="profile-chart"></div>
  <div class="tradingview-widget-copyright"></div>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script type="text/javascript">
  new TradingView.widget(
  {
  "autosize": "true",
  "symbol": "SPY",
  "interval": "D",
  "timezone": "Etc/UTC",
  "theme": "dark",
  "style": "2",
  "locale": "en",
  "toolbar_bg": "#f1f3f6",
  "enable_publishing": false,
  "hide_side_toolbar": false,
  "allow_symbol_change": true,
  "container_id": "tradingview_ffdae"
}
  );
  </script>
</div>
<!-- TradingView Widget END -->
<div class="goldbar"></div>
  <!-- TradingView Widget BEGIN -->
<div class="tradingview-widget-container">
  <div class="tradingview-widget-container__widget" id="profile-chart2" style="height: 600px"></div>
  <div class="tradingview-widget-copyright"></div>
  <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-screener.js" async>
  {
  "width": "100%",

  "autosize": "true",
  "defaultColumn": "overview",
  "defaultScreen": "most_capitalized",
  "market": "america",
  "showToolbar": true,
  "colorTheme": "dark",
  "locale": "en"

  }
    </script>
  </div>
<!-- TradingView Widget END -->
</div>
</div>
